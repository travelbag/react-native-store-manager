# Store Manager API

A Node.js API with MySQL for the React Native Store Manager app, handling push notifications and order management.

## ğŸš€ Quick Start

### Prerequisites
- Node.js 16+ 
- MySQL 8.0+
- npm or yarn

### Installation

1. **Clone and Install**
```bash
cd backend
npm install
```

2. **Configure Environment**
```bash
cp .env.example .env
# Edit .env with your database credentials
```

3. **Setup Database**
```bash
npm run setup
```

4. **Start Development Server**
```bash
npm run dev
```

## ğŸ“Š Database Schema

### Tables Created
- **stores** - Store information
- **store_managers** - Store manager details  
- **push_tokens** - Push notification tokens
- **orders** - Customer orders
- **order_items** - Individual order items

## ğŸ›  API Endpoints

### Store Managers
```
POST /api/store-managers/register-token
GET  /api/store-managers/:managerId/tokens
GET  /api/store-managers/store/:storeId
DELETE /api/store-managers/tokens/:tokenId
GET  /api/store-managers/store/:storeId/tokens
```

### Orders
```
POST /api/orders
GET  /api/orders/:orderId
GET  /api/orders/store/:storeId
PUT  /api/orders/:orderId/status
PUT  /api/orders/items/:itemId/status
```

### System
```
GET /api/health
GET /
```

## ğŸ“± Push Token Registration

**Endpoint:** `POST /api/store-managers/register-token`

**Request:**
```json
{
  "storeManagerId": "SM_001",
  "storeId": "STORE_001",
  "pushToken": "ExponentPushToken[xxxxx]",
  "deviceInfo": {
    "platform": "ios",
    "timestamp": "2025-08-21T10:30:00Z"
  }
}
```

**Response:**
```json
{
  "success": true,
  "message": "Push token registered successfully",
  "data": {
    "tokenId": "uuid-token-id",
    "storeManagerId": "SM_001",
    "storeId": "STORE_001",
    "registeredAt": "2025-08-21T10:30:00Z"
  }
}
```

## ğŸ›’ Order Creation

**Endpoint:** `POST /api/orders`

**Request:**
```json
{
  "customerName": "John Doe",
  "customerEmail": "john@example.com",
  "storeId": "STORE_001",
  "totalAmount": 25.99,
  "deliveryAddress": "123 Main St",
  "items": [
    {
      "productName": "Organic Bananas",
      "price": 2.99,
      "quantity": 2,
      "barcode": "123456789012",
      "rackLocation": "A1-B2"
    }
  ]
}
```

## ğŸ”§ Configuration

### Environment Variables (.env)
```bash
PORT=3000
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=store_manager_db
JWT_SECRET=your-secret-key
```

### Sample Data
The setup script creates:
- 2 sample stores
- 3 sample store managers  
- Proper database relationships

## ğŸ›¡ Security Features

- **Helmet** - Security headers
- **Rate Limiting** - 100 requests per 15 minutes
- **CORS** - Configurable origins
- **Input Validation** - Joi schema validation
- **SQL Injection Protection** - Parameterized queries

## ğŸ“‹ Development Scripts

```bash
npm start      # Production server
npm run dev    # Development with nodemon
npm run setup  # Setup database and tables
```

## ğŸ”— Integration with React Native App

1. Update `/src/config/api.js` in your React Native app:
```javascript
export const API_CONFIG = {
  BASE_URL: 'http://your-server.com/api',
  DEMO_MODE: false, // Disable demo mode
};
```

2. Your app will automatically:
   - Register push tokens on startup
   - Listen for real order notifications
   - Fetch order details from API

## ğŸ“± Push Notification Flow

1. **App Startup** â†’ Register token with API
2. **Customer Orders** â†’ API creates order + sends push notification  
3. **Store Manager** â†’ Receives notification + fetches order details
4. **Order Processing** â†’ Updates sent back to API

## ğŸš€ Deployment

### Using AWS/Docker/VPS:
1. Set production environment variables
2. Run `npm run setup` on production DB
3. Start with `npm start`
4. Configure nginx/load balancer if needed

### Environment Variables for Production:
```bash
NODE_ENV=production
DB_HOST=your-production-db-host
API_BASE_URL=https://your-domain.com/api
```

## ğŸ§ª Testing

Test the API:
```bash
# Health check
curl http://localhost:3000/api/health

# Register token
curl -X POST http://localhost:3000/api/store-managers/register-token \
  -H "Content-Type: application/json" \
  -d '{"storeManagerId":"SM_001","storeId":"STORE_001","pushToken":"test","deviceInfo":{"platform":"ios"}}'
```

## ğŸ” Troubleshooting

**Database Connection Issues:**
- Check MySQL is running
- Verify credentials in .env
- Ensure database exists

**Push Notifications Not Working:**
- Verify tokens are registered
- Check Expo push service setup
- Test with development notifications first

**API Errors:**
- Check server logs
- Verify request format matches validation schemas
- Ensure all required fields are provided
